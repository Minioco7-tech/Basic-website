<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results | AIviary</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="bg-gradient-to-b from-gray-900 to-black text-white min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-6 flex justify-between items-center border-b border-white border-opacity-10">
        <h1 class="text-2xl font-bold">üîç AIviary Search</h1>
        <a href="index.html" class="text-sm text-gray-300 hover:text-white transition">Back to Home</a>
    </header>

    <!-- Search Results Section -->
    <main class="flex-1 container mx-auto px-4 py-10">
         
        <div class="flex justify-between items-center mb-6">
            <h2 id="categoryTitle" class="text-2xl font-bold"></h2>
            <button id="randomiseBtn" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm rounded-lg transition flex items-center space-x-2">
                <i data-feather="shuffle" class="w-4 h-4"></i>
                <span>Randomise</span>
            </button>
        </div>
        
        <div id="resultsGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
        <div id="noResults" class="text-center text-gray-400 mt-12 hidden">
            No results found for "<span id="queryText" class="text-white"></span>" üòï
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center text-sm text-gray-500 py-4 border-t border-white border-opacity-10">
        ¬© 2025 AIviary. All rights reserved.
    </footer>

    <script>
    const resultsGrid = document.getElementById('resultsGrid');
    const noResults = document.getElementById('noResults');
    const queryText = document.getElementById('queryText');
    const stopwords = ['i','want','to','a','the','and','for','of','in','on','is','with','my','you','it','this','that','at'];
    const randomiseBtn = document.getElementById('randomiseBtn');
        
    // Get query from URL
    const params = new URLSearchParams(window.location.search);
    const searchQuery = params.get('q')?.trim().toLowerCase() || '';

    // Display search term
    queryText.textContent = searchQuery;

    // Global array to store models currently displayed
    let currentModels = [];

    // ‚úÖ Category synonyms for natural matching
    const categorySynonyms = {
        writing: ['writing', 'writer', 'content', 'copy', 'text', 'document', 'email'],
        design: ['design', 'art', 'image', 'photo', 'logo', 'graphic', 'visual'],
        learning: ['learning', 'education', 'research', 'study', 'teach', 'knowledge'],
        business: ['business', 'marketing', 'sales', 'brand', 'startup', 'work', 'help'],
        chatbots: ['chat', 'bot', 'assistant', 'agent', 'conversation', 'support'],
        music: ['music', 'audio', 'sound', 'song', 'beat', 'voice', 'sing'],
        coding: ['code', 'coding', 'developer', 'programming', 'software', 'tech'],
        science: ['science', 'health', 'medicine', 'bio', 'lab', 'research'],
        finance: ['finance', 'money', 'analytics', 'data', 'economy', 'bank', 'invest'],
        health: ['health', 'fitness', 'wellbeing', 'medical', 'care', 'wellness']
    };

    // Helper: check if query matches a category
    function getMatchedCategory(keywords) {
        for (const [key, synonyms] of Object.entries(categorySynonyms)) {
            if (keywords.some(word => synonyms.includes(word))) return key;
        }
        return null;
    }
    
    // Enhanced natural search logic
    async function fetchAndDisplayResults() {
        try {
            const response = await fetch('./models.json');
            if (!response.ok) throw new Error('Failed to load models.json');
            const models = await response.json();
    
           
            const keywords = searchQuery
                .split(/\s+/)
                .map(w => w.toLowerCase())
                .filter(Boolean)
                .filter(word => !stopwords.includes(word));
    
            let filtered = [];
            const matchedCategory = getMatchedCategory(keywords);
    
            // Show all models for general queries like "all"
            if (['all', 'everything', 'all tools', 'catalogue'].includes(searchQuery)) {
                filtered = models;
            } 
            // Match category if found
            else if (matchedCategory) {
                filtered = models.filter(m => m.category.toLowerCase() === matchedCategory);
            } 
            // General fuzzy search with Fuse.js
            else {
                const fuse = new Fuse(models, {
                    keys: ['name', 'description', 'category', 'type'],
                    threshold: 0.4,        // fuzzy tolerance
                    ignoreLocation: true,
                    includeScore: true
                });
    
                filtered = fuse.search(searchQuery)
                    .map(result => result.item);
            }
    
            // Randomize results slightly for variety
            filtered = filtered.sort(() => 0.5 - Math.random());
    
            // Display results or show noResults
            if (filtered.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
    
            resultsGrid.innerHTML = '';
            filtered.forEach(model => {
                const card = document.createElement('div');
                card.className = 'bg-black bg-opacity-30 rounded-xl overflow-hidden hover:scale-105 transition transform duration-300 border border-white border-opacity-10';
                card.innerHTML = `
                    <div class="w-full h-40 bg-cover bg-center" style="background-image: url('${model.image}')"></div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-2">${model.name}</h3>
                        <p class="text-sm text-gray-300 mb-3 line-clamp-2">${model.description}</p>
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>${model.category}</span>
                            <a href="model.html?id=${encodeURIComponent(model.id)}" class="text-purple-400 hover:text-purple-300">View ‚Üí</a>
                        </div>
                    </div>
                `;
                resultsGrid.appendChild(card);
            });
    
        } catch (error) {
            console.error('Error loading models:', error);
            noResults.classList.remove('hidden');
        }
    }

    // Fisher‚ÄìYates shuffle (mobile-safe)
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Randomise button functionality
    randomiseBtn.addEventListener('click', () => {
        if (!currentModels.length) return;
    
        // Shuffle models
        currentModels = shuffleArray(currentModels);
    
        // Clear grid to force repaint (fixes mobile rendering bug)
        modelsGrid.innerHTML = '';
    
        // Repaint on next frame to ensure smooth reshuffle
        requestAnimationFrame(() => {
            displayModels(currentModels);
            window.scrollTo({ top: 0, behavior: 'smooth' });
    
            // Force mobile browsers (especially iOS Safari) to repaint
            setTimeout(() => {
                document.body.style.transform = 'translateZ(0)';
            }, 100);
        });
    });
    
    // Run search
    fetchAndDisplayResults();
    </script>
</body>
</html>
